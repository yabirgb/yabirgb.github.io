<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="Introduction Last week I wanted to emulate the css effects in python on images. The filter that caught my attention was the sepia filter. I write this because I couldn&rsquo;t find much information about the topic on the web.
Basics A quick search on your favourite search engine leads to this page where as mentioned in stackoverflow (1) what you have to do is:
outputRed = (inputRed * .393) &#43; (inputGreen *.">

<meta property="og:title" content="Creating a sepia filter with python" />
<meta property="og:description" content="Introduction Last week I wanted to emulate the css effects in python on images. The filter that caught my attention was the sepia filter. I write this because I couldn&rsquo;t find much information about the topic on the web.
Basics A quick search on your favourite search engine leads to this page where as mentioned in stackoverflow (1) what you have to do is:
outputRed = (inputRed * .393) &#43; (inputGreen *." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yabirgb.com/blog/creating-a-sepia-filter-with-python/" />
<meta property="article:published_time" content="2019-02-08T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-02-08T00:00:00&#43;00:00"/>


<title>


     Creating a sepia filter with python 

</title>
<link rel="canonical" href="https://yabirgb.com/blog/creating-a-sepia-filter-with-python/">










<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    
    <link rel="stylesheet" href="https://yabirgb.com/css/reset.css?t=2019-02-17%2013%3a02%3a40.712408793%20%2b0100%20CET%20m%3d%2b0.059786577">
    <link rel="stylesheet" href="https://yabirgb.com/css/pygments.css?t=2019-02-17%2013%3a02%3a40.712408793%20%2b0100%20CET%20m%3d%2b0.059786577">
    <link rel="stylesheet" href="https://yabirgb.com/css/main.css?t=2019-02-17%2013%3a02%3a40.712408793%20%2b0100%20CET%20m%3d%2b0.059786577">
    




<link rel="shortcut icon"

    href="https://yabirgb.com/img/favicon.ico"

>








</head>


<body lang="en">

<section class="header">
    <div class="container">
        <div class="content">
            
            <a href="https://yabirgb.com/"><div class="name"></div></a>
            
            <nav>
                <ul>
                    
                        <li class="nav-home"><a href="https://yabirgb.com/"><span>Home</span></a></li>
                    
                        <li class="nav-blog"><a href="https://yabirgb.com/blog/"><span>Blog</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//github.com/yabirgb" target="_blank" rel="noopener"><img class="icon" src="https://yabirgb.com/img/github.svg" alt="github" /></a>
        

        
            <a href="//twitter.com/yabirgb" target="_blank" rel="noopener"><img class="icon" src="https://yabirgb.com/img/twitter.svg" alt="twitter" /></a>
        

	

        

        
            <a href="//mstdn.io/@yabirgb" target="_blank" rel="noopener"><img class="icon" src="https://yabirgb.com/img/mastodon.svg" alt="mastodon" /></a>
        

        
            <a href="//linkedin.com/in/y%c3%a1bir-garc%c3%ada-benchakhtir-8662b7128" target="_blank" rel="noopener"><img class="icon" src="https://yabirgb.com/img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        
            <a href="mailto:yabirg@protonmail.com"><img class="icon" src="https://yabirgb.com/img/email.svg" alt="email" /></a>
        

        

        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Creating a sepia filter with python

</div>

                    <div class="initials"><a href="https://yabirgb.com/"></a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='Fri Feb 8 2019 00:00:00 UTC'>Feb 8, 2019</div>
                    
                    
		    <div class="reading-time"><div class="middot"></div>4 minutes read</div>
                    
                </div>
            </div>
            <div class="markdown">
                

<h2 id="introduction">Introduction</h2>

<p>Last week I wanted to emulate the css effects in python on
images. The filter that caught my attention was the sepia filter.  I
write this because I couldn&rsquo;t find much information about the topic on
the web.</p>

<h2 id="basics">Basics</h2>

<p>A quick search on your favourite search engine leads to <a href="https://www.techrepublic.com/blog/how-do-i/how-do-i-convert-images-to-grayscale-and-sepia-tone-using-c/">this
page</a>
where as mentioned in stackoverflow (<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>) what you have to do is:</p>

<pre><code>outputRed = (inputRed * .393) + (inputGreen *.769) + (inputBlue * .189)
outputGreen = (inputRed * .349) + (inputGreen *.686) + (inputBlue * .168)
outputBlue = (inputRed * .272) + (inputGreen *.534) + (inputBlue * .131)
</code></pre>

<p>The result is (Image by Andrea Ranalleta on Unsplash):</p>

<p><img src="https://yabirgb.com/images/andrea-ranalletta-1368337-unsplash-min.jpg" style="display: float;  align-self:center; margin-left:16.5%; width:33%">
<img src="https://yabirgb.com/images/andrea-ranalletta-1368337-unsplash-min.sepia.jpg" style="display: float;  align-self:center; width:33%"></p>

<h2 id="coding-this-on-python">Coding this on python</h2>

<p>With this information what you have to do is to ignore the alpha layer
and for each pixel calculate a bunch of numbers.</p>

<p>You can use <code>Pillow</code> for this and then on your program:</p>

<pre><code>from PIL import Image

def sepia(image_path:str)-&gt;Image:
    img = Image.open(image_path)
    width, height = img.size

    pixels = img.load() # create the pixel map

    for py in range(height):
     for px in range(width):
         r, g, b = img.getpixel((px, py))

         tr = int(0.393 * r + 0.769 * g + 0.189 * b)
         tg = int(0.349 * r + 0.686 * g + 0.168 * b)
         tb = int(0.272 * r + 0.534 * g + 0.131 * b)

         if tr &gt; 255:
             tr = 255

         if tg &gt; 255:
             tg = 255

         if tb &gt; 255:
             tb = 255

         pixels[px, py] = (tr,tg,tb)

    return img
</code></pre>

<p>Here I&rsquo;m assuming that the image is a <code>jpeg</code>, but in case of a <code>png</code> is
similar but taking care of the alpha layer. This is easy, but very <strong>slow</strong>, so &hellip; how can this be faster?</p>

<p>My next search was for applying filters to images and I discovered cv2.
Scrolling fast the docs I wrote this:</p>

<pre><code>import cv2
import numpy as np
from PIL import Image

def sepia_cv(image_path:str)-&gt;Image:
    &quot;&quot;&quot;
    Optimization on the sepia filter using cv2 
    &quot;&quot;&quot;

    image = Image.open(image_path)

    # Load the image as an array so cv knows how to work with it
    img = np.array(image)

    # Apply a transformation where we multiply each pixel rgb 
    # with the matrix for the sepia

    filt = cv2.transform( img, np.matrix([[ 0.393, 0.769, 0.189],
                                          [ 0.349, 0.686, 0.168],
                                          [ 0.272, 0.534, 0.131]                                  
    ]) )

    # Check wich entries have a value greather than 255 and set it to 255
    filt[np.where(filt&gt;255)] = 255

    # Create an image from the array 
    return Image.fromarray(filt)
</code></pre>

<p>What is happening here is that the previous sums and products are no
more than a linear transformation between subspaces of the reals,
so we can represent this as a matrix. But loading <code>cv2</code> and <code>numpy</code>
for this is too much so let&rsquo;s just use numpy.</p>

<pre><code>def sepia_np(image_path:str)-&gt;Image:
    &quot;&quot;&quot;
    Optimization on the sepia filter using numpy 
    &quot;&quot;&quot;

    image = Image.open(image_path)

    # Load the image as an array so cv knows how to work with it
    img = np.array(image)

    # Apply a transformation where we multiply each pixel 
    # rgb with the matrix transformation for the sepia

    lmap = np.matrix([[ 0.393, 0.769, 0.189],
                      [ 0.349, 0.686, 0.168],
                      [ 0.272, 0.534, 0.131]                                  
    ])

    filt = np.array([x * lmap.T for x in img] )

    # Check wich entries have a value greather than 255 and set it to 255
    filt[np.where(filt&gt;255)] = 255

    # Create an image from the array
    return Image.fromarray(filt.astype('uint8'))
</code></pre>

<p>In this solution take care of (<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>)</p>

<h2 id="improving-the-filter">Improving the filter</h2>

<p>In <code>CSS</code> you can apply an scale to the filter. After searching a lot I
found <a href="https://drafts.fxtf.org/filter-effects/#sepiaEquivalent"><em>this
link</em></a> where
it specifies how to apply the filter using this scale. The thing is
that aside the linear map, you are using a movement. The
transformation matrix is:</p>

<pre><code>    matrix = [[ 0.393 + 0.607 * (1 - k), 0.769 - 0.769 * (1 - k), 0.189 - 0.189 * (1 - k)],
    [ 0.349 - 0.349 * (1 - k), 0.686 + 0.314 * (1 - k), 0.168 - 0.168 * (1 - k)],
    [ 0.272 - 0.349 * (1 - k), 0.534 - 0.534* (1 - k), 0.131 + 0.869 * (1 - k)]]
</code></pre>

<p>where <code>k</code> is the interval [0,1].</p>

<p>Here are some examples:</p>

<ul>
<li>Sepia with amount = 0 (original image)</li>
</ul>

<p><img src="https://yabirgb.com/images/andrea-ranalletta-1368337-unsplash-min.sepia.0.jpg" style="width:33%"></p>

<ul>
<li>Sepia with amount = 0.3</li>
</ul>

<p><img src="https://yabirgb.com/images/andrea-ranalletta-1368337-unsplash-min.sepia.0.3.jpg" style="width:33%"></p>

<ul>
<li>Sepia with amount = 0.7</li>
</ul>

<p><img src="https://yabirgb.com/images/andrea-ranalletta-1368337-unsplash-min.sepia.0.7.jpg" style="width:33%"></p>

<ul>
<li>Sepia with amount = 1 (the same filter we created initally)</li>
</ul>

<p><img src="https://yabirgb.com/images/andrea-ranalletta-1368337-unsplash-min.sepia.1.jpg" style="width:33%"></p>

<h2 id="measuring-times">Measuring times</h2>

<p>Calling <code>python -m cProfile test.py</code> (<sup class="footnote-ref" id="fnref:3"><a href="#fn:3">3</a></sup>) with my Pentium G3258 on the image used in this post (2453x2453 pixels):</p>

<pre><code>    ncalls  tottime  percall  cumtime  percall filename:lineno(function)

         1    0.007    0.007    0.293    0.293 test.py:34(sepia_cv)
         1    0.033    0.033    0.499    0.499 test.py:56(sepia_np)
         1    7.857    7.857   16.634   16.634 test.py:7(sepia)
</code></pre>

<p>This times don&rsquo;t count the time importing the modules used.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://stackoverflow.com/questions/1061093/how-is-a-sepia-tone-created">How is a sepia tone created?</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2"><a href="https://stackoverflow.com/a/27623335">Why we need uint8</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
<li id="fn:3"><a href="https://docs.python.org/3/library/profile.html">cProfile</a>
 <a class="footnote-return" href="#fnref:3"><sup>[return]</sup></a></li>
</ol>
</div>

                <br>
		<p class="back-to-posts"><a href="https://yabirgb.com/blog/">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
            
        </div>
    </div>
</section>









</body>
</html>

